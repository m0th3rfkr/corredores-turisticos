<script>
    const SUPABASE_URL = 'https://ksiiidnvtktlowlhtebs.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzaWlpZG52dGt0bG93bGh0ZWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTIxMzMsImV4cCI6MjA3NjM4ODEzM30.aNctRZSRaINDV4ehb00848g4Y-70UeFviNbsmS8jQUw';
    
    const corredores = {
        'zona-rosa': { 
            nombre: 'Zona Rosa', 
            icon: 'üåπ', 
            desc: 'Cultura y entretenimiento', 
            id: '8aad43fc-9854-40d3-a73b-2558f42d14ad' 
        },
        'basilica': { 
            nombre: 'Bas√≠lica', 
            icon: '‚õ™', 
            desc: 'Fe y tradici√≥n', 
            id: 'b1663b4b-466f-433f-9f8a-9ea2508ad032' 
        },
        'centro-historico': { 
            nombre: 'Centro Hist√≥rico', 
            icon: 'üèõÔ∏è', 
            desc: 'Coraz√≥n de CDMX', 
            id: '1a607716-bad4-4982-ba13-99884c02a730' 
        },
        'chapultepec': { 
            nombre: 'Chapultepec', 
            icon: 'üå≥', 
            desc: 'Pulm√≥n verde', 
            id: 'b90c50e9-027e-4394-ac13-57f29d4bc84f' 
        },
        'coyoacan': { 
            nombre: 'Coyoac√°n', 
            icon: 'üé®', 
            desc: 'Arte y bohemia', 
            id: '97493529-0625-44c7-a514-0b41cf612903' 
        },
        'garibaldi': { 
            nombre: 'Garibaldi', 
            icon: 'üé∫', 
            desc: 'Mariachi', 
            id: '762ff70a-2f15-4422-82ad-96d271b09bd2' 
        },
        'xochimilco': { 
            nombre: 'Xochimilco', 
            icon: 'üö£', 
            desc: 'Trajineras', 
            id: 'bc2c91a3-b564-4962-b74d-e13b6b7cb1b3' 
        }
    };
    
    const params = new URLSearchParams(window.location.search);
    const corridorSlug = params.get('corredor') || 'zona-rosa';
    const corredor = corredores[corridorSlug];
    let allPlaces = [];
    let selectedFilters = [];
    let tempFilters = [];
    
    // Actualizar t√≠tulo
    document.getElementById('corridorName').innerHTML = corredor.icon + ' ' + corredor.nombre;
    document.getElementById('corridorDesc').textContent = corredor.desc;
    
    async function loadPlaces() {
        const container = document.getElementById('placesList');
        try {
            const tables = [
                { name: 'restaurantes', emoji: 'üçΩÔ∏è' },
                { name: 'hoteles', emoji: 'üè®' },
                { name: 'imperdibles', emoji: '‚≠ê' },
                { name: 'estacionamientos', emoji: 'üÖøÔ∏è' },
                { name: 'estaciones_ecobici', emoji: 'üö≤' }
            ];
            
            const promises = tables.map(async table => {
                const url = `${SUPABASE_URL}/rest/v1/${table.name}?corredor_id=eq.${corredor.id}&select=*`;
                const response = await fetch(url, {
                    headers: { 
                        'apikey': ANON_KEY, 
                        'Authorization': `Bearer ${ANON_KEY}`
                    }
                });
                if (!response.ok) return [];
                const data = await response.json();
                return data.map(p => ({...p, tipo: table.name, emoji: table.emoji}));
            });
            
            const results = await Promise.all(promises);
            allPlaces = results.flat();
            
            updateCounters();
            renderPlaces(allPlaces);
            document.getElementById('filter-all').checked = true;
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="error">Error al cargar lugares. Por favor recarga la p√°gina.</div>';
        }
    }
    
    function updateCounters() {
        const counts = {
            restaurantes: allPlaces.filter(p => p.tipo === 'restaurantes').length,
            hoteles: allPlaces.filter(p => p.tipo === 'hoteles').length,
            imperdibles: allPlaces.filter(p => p.tipo === 'imperdibles').length,
            estacionamientos: allPlaces.filter(p => p.tipo === 'estacionamientos').length,
            estaciones_ecobici: allPlaces.filter(p => p.tipo === 'estaciones_ecobici').length
        };
        
        document.getElementById('count-all').textContent = allPlaces.length;
        document.getElementById('count-restaurantes').textContent = counts.restaurantes;
        document.getElementById('count-hoteles').textContent = counts.hoteles;
        document.getElementById('count-imperdibles').textContent = counts.imperdibles;
        document.getElementById('count-estacionamientos').textContent = counts.estacionamientos;
        document.getElementById('count-estaciones_ecobici').textContent = counts.estaciones_ecobici;
    }
    
    function renderPlaces(places) {
        const container = document.getElementById('placesList');
        if (places.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No hay lugares en esta categor√≠a</p>';
            return;
        }
        
        const typeLabels = { 
            'restaurantes': 'üçΩÔ∏è Restaurante', 
            'hoteles': 'üè® Hotel', 
            'imperdibles': '‚≠ê Imperdible',
            'estacionamientos': 'üÖøÔ∏è Estacionamiento',
            'estaciones_ecobici': 'üö≤ EcoBici'
        };
        
        container.innerHTML = places.map(place => {
            const emoji = place.emoji || 'üìç';
            const imageContent = place.imagen_principal_url 
                ? `<img src="${place.imagen_principal_url}" style="width:100%;height:100%;object-fit:cover;" alt="${place.nombre}">`
                : emoji;
                
            return `<div class="place-card" onclick="openPlace('${place.id}', '${place.tipo}')">
                <div class="place-img">${imageContent}</div>
                <div class="place-info">
                    <span class="place-type">${typeLabels[place.tipo] || place.tipo}</span>
                    <div class="place-name">${place.nombre || 'Sin nombre'}</div>
                    ${place.descripcion_corta ? `<div class="place-desc">${place.descripcion_corta.substring(0, 100)}...</div>` : ''}
                    ${place.direccion ? `<div class="place-address">üìç ${place.direccion}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }
    
    function toggleFilterDropdown() {
        const dropdown = document.getElementById('filterDropdown');
        const button = document.getElementById('filterToggle');
        const isOpen = dropdown.classList.contains('show');
        
        if (!isOpen) {
            // Al abrir, sincronizar checkboxes con los filtros activos
            tempFilters = [...selectedFilters];
            
            // Actualizar checkboxes
            if (selectedFilters.length === 0) {
                // Si no hay filtros, marcar solo "todos"
                document.getElementById('filter-all').checked = true;
                ['restaurantes', 'hoteles', 'imperdibles', 'estacionamientos', 'estaciones_ecobici'].forEach(type => {
                    document.getElementById(`filter-${type}`).checked = false;
                });
            } else {
                // Si hay filtros espec√≠ficos, marcar solo esos
                document.getElementById('filter-all').checked = false;
                ['restaurantes', 'hoteles', 'imperdibles', 'estacionamientos', 'estaciones_ecobici'].forEach(type => {
                    document.getElementById(`filter-${type}`).checked = selectedFilters.includes(type);
                });
            }
        }
        
        dropdown.classList.toggle('show');
        button.classList.toggle('active');
    }
    
    function toggleCheckbox(type) {
        if (type === 'all') {
            // Si se selecciona "todos", limpiar filtros
            tempFilters = [];
            document.getElementById('filter-all').checked = true;
            ['restaurantes', 'hoteles', 'imperdibles', 'estacionamientos', 'estaciones_ecobici'].forEach(t => {
                document.getElementById(`filter-${t}`).checked = false;
            });
        } else {
            const checkbox = document.getElementById(`filter-${type}`);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                // Agregar a filtros temporales
                if (!tempFilters.includes(type)) {
                    tempFilters.push(type);
                }
                document.getElementById('filter-all').checked = false;
            } else {
                // Quitar de filtros temporales
                tempFilters = tempFilters.filter(f => f !== type);
            }
            
            // Si no hay filtros, marcar "todos"
            if (tempFilters.length === 0) {
                document.getElementById('filter-all').checked = true;
            }
        }
    }
    
    function applyFilter() {
        // Copiar filtros temporales a filtros activos
        selectedFilters = [...tempFilters];
        
        // Actualizar display de tags
        updateSelectedFiltersDisplay();
        
        // Aplicar los filtros a los lugares
        applyFilters();
        
        // Cerrar el dropdown
        toggleFilterDropdown();
    }
    
    function cancelFilter() {
        tempFilters = [...selectedFilters];
        toggleFilterDropdown();
    }
    
    function updateSelectedFiltersDisplay() {
        const container = document.getElementById('selectedFilters');
        const categoryInfo = {
            'restaurantes': { emoji: 'üçΩÔ∏è', name: 'Restaurantes' },
            'hoteles': { emoji: 'üè®', name: 'Hoteles' },
            'imperdibles': { emoji: '‚≠ê', name: 'Imperdibles' },
            'estacionamientos': { emoji: 'üÖøÔ∏è', name: 'Parking' },
            'estaciones_ecobici': { emoji: 'üö≤', name: 'EcoBici' }
        };
        
        if (selectedFilters.length === 0) {
            container.innerHTML = '<span class="placeholder-text">Mostrando todos los lugares</span>';
        } else {
            container.innerHTML = selectedFilters.map(filter => {
                const info = categoryInfo[filter];
                return `<div class="filter-tag">
                    <span>${info.emoji} ${info.name}</span>
                    <span class="remove" onclick="removeFilter('${filter}')">√ó</span>
                </div>`;
            }).join('');
        }
    }
    
    function removeFilter(type) {
        selectedFilters = selectedFilters.filter(f => f !== type);
        updateSelectedFiltersDisplay();
        applyFilters();
    }
    
    function applyFilters() {
        let filtered;
        if (selectedFilters.length === 0) {
            filtered = allPlaces;
            document.getElementById('feedTitle').textContent = 'Todos los lugares';
        } else {
            // Filtrar por las categor√≠as seleccionadas
            filtered = allPlaces.filter(place => {
                return selectedFilters.includes(place.tipo);
            });
            const totalFiltered = filtered.length;
            document.getElementById('feedTitle').textContent = `Mostrando ${totalFiltered} ${totalFiltered === 1 ? 'lugar' : 'lugares'}`;
        }
        renderPlaces(filtered);
    }
    
    function openPlace(id, tipo) {
        window.location.href = `place.html?tipo=${tipo}&id=${id}&corredor=${corridorSlug}`;
    }
    
    function openMap() {
        window.location.href = `mapa.html?corredor=${corridorSlug}`;
    }
    
    // Click fuera del dropdown para cerrarlo
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-section')) {
            const dropdown = document.getElementById('filterDropdown');
            if (dropdown.classList.contains('show')) {
                cancelFilter();
            }
        }
    });
    
    loadPlaces();
</script>
